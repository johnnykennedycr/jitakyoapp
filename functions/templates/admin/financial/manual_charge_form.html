{% extends 'admin/base_admin.html' %}

{% block admin_title %}Adicionar Cobrança Avulsa{% endblock %}

{% block content %}
<div class="container mx-auto p-6 md:p-10">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Adicionar Cobrança Avulsa</h1>

        {% include 'admin/partials/flash_messages.html' ignore missing %}

        <form method="POST" class="space-y-6">
            <div class="autocomplete-container relative w-full">
                <label for="student-search-input" class="block text-sm font-medium text-gray-700">Aluno</label>
                <input id="student-search-input" type="text" placeholder="Digite o nome ou e-mail do aluno..." required autocomplete="off" class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <div id="student-search-results" class="autocomplete-items hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto"></div>
                <input id="student-id" type="hidden" name="student_id">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                    <input type="number" step="0.01" name="amount" id="amount" required placeholder="50.00" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="due_date" class="block text-sm font-medium text-gray-700">Data de Vencimento</label>
                    <input type="date" name="due_date" id="due_date" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                </div>
            </div>
            
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700">Descrição</label>
                <input type="text" name="description" id="description" required placeholder="Ex: Venda de Kimono, Exame de Faixa" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
            </div>

            <div class="flex justify-end space-x-4 pt-4">
                <a href="{{ url_for('admin.financial_dashboard') }}" class="px-6 py-2 border border-gray-300 text-base font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">Cancelar</a>
                <button type="submit" id="submit-button" disabled class="inline-flex items-center px-6 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Criar Cobrança</button>
            </div>
        </form>
    </div>
</div>

<script type="application/json" id="students-data">
    {{ students_json|tojson|safe }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const studentSearchInput = document.getElementById('student-search-input');
    const searchResultsContainer = document.getElementById('student-search-results');
    const studentIdInput = document.getElementById('student-id');
    const submitButton = document.getElementById('submit-button');
    const studentsDataElement = document.getElementById('students-data');
    const students = studentsDataElement ? JSON.parse(studentsDataElement.textContent) : [];

    studentSearchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        searchResultsContainer.innerHTML = '';
        studentIdInput.value = '';
        submitButton.disabled = true;

        if (query.length < 2) {
            searchResultsContainer.classList.add('hidden');
            return;
        }

        const filteredStudents = students.filter(s => 
            s.name.toLowerCase().includes(query) || s.email.toLowerCase().includes(query)
        );

        if (filteredStudents.length > 0) {
            searchResultsContainer.classList.remove('hidden');
            filteredStudents.forEach(student => {
                const resultDiv = document.createElement('div');
                resultDiv.classList.add('px-4', 'py-2', 'cursor-pointer', 'hover:bg-gray-100');
                resultDiv.innerHTML = `<strong>${student.name}</strong> <span class="text-xs text-gray-500">(${student.email})</span>`;
                resultDiv.addEventListener('click', () => {
                    studentSearchInput.value = student.name;
                    studentIdInput.value = student.id;
                    searchResultsContainer.classList.add('hidden');
                    submitButton.disabled = false;
                });
                searchResultsContainer.appendChild(resultDiv);
            });
        } else {
            searchResultsContainer.classList.add('hidden');
        }
    });

    document.addEventListener('click', e => {
        if (!e.target.closest('.autocomplete-container')) {
            searchResultsContainer.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}