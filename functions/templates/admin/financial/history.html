{% extends 'admin/base_admin.html' %}

{% block admin_title %}Histórico de Pagamentos{% endblock %}

{% block content %}
<div class="container mx-auto p-6 md:p-10">
    <h1 class="text-3xl font-bold text-gray-100 mb-8">Histórico de Pagamentos</h1>
    
    {% include 'admin/partials/flash_messages.html' ignore missing %}

    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <form method="GET" action="{{ url_for('admin.payment_history') }}">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                <div>
                    <label for="year" class="block text-sm font-medium text-gray-700">Ano</label>
                    <select name="year" id="year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        {% for year in years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="month" class="block text-sm font-medium text-gray-700">Mês</label>
                    <select name="month" id="month" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="">Todos</option>
                        {% for i in range(1, 13) %}
                        <option value="{{ i }}" {% if i == selected_month %}selected{% endif %}>{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="class_id" class="block text-sm font-medium text-gray-700">Turma</label>
                    <select name="class_id" id="class_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="">Todas</option>
                        {% for class in all_classes %}
                        <option value="{{ class.id }}" {% if class.id == selected_class_id %}selected{% endif %}>{{ class.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select name="status" id="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="">Todos</option>
                        <option value="paid" {% if selected_status == 'paid' %}selected{% endif %}>Pago</option>
                        <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pendente</option>
                        <option value="overdue" {% if selected_status == 'overdue' %}selected{% endif %}>Atrasado</option>
                    </select>
                </div>
                <div>
                    <button type="submit" class="w-full px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Filtrar</button>
                </div>
            </div>
        </form>
    </div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700">Total Recebido no Período</h3>
            <p class="text-3xl font-bold text-green-600 mt-2">R$ {{ "%.2f"|format(total_received_in_period) }}</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700">Total a Receber no Período</h3>
            <p class="text-3xl font-bold text-yellow-600 mt-2">R$ {{ "%.2f"|format(total_pending_in_period) }}</p>
        </div>
    </div> 
    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aluno</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimento</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Pagto.</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Forma de Pagto.</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in payments %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <div>{{ item.student_name }}</div>
                        <div class="text-xs text-gray-500">{{ item.class_name }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.payment.due_date.strftime('%d/%m/%Y') }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.payment.payment_date.strftime('%d/%m/%Y') if item.payment.payment_date else '-' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.payment.payment_method if item.payment.payment_method else '-' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ {{ "%.2f"|format(item.payment.amount) }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                        {% set status = item.payment.status %}
                        {% if status == 'paid' %}
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Pago</span>
                        {% elif status == 'pending' %}
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pendente</span>
                        {% elif status == 'overdue' %}
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Atrasado</span>
                        {% else %}
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">{{ status|capitalize }}</span>
                        {% endif %}
                    </td>
</tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center p-12 text-gray-500">Nenhum pagamento encontrado com os filtros selecionados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}