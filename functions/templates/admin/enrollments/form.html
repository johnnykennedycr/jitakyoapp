{% extends 'admin/base_admin.html' %}

{% block admin_title %}Nova Matrícula{% endblock %}

{% block content %}
<div class="p-6 md:p-10">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Nova Matrícula</h1>
        <p class="text-lg text-indigo-600 font-semibold mb-6">Turma: {{ training_class.name }}</p>

        {% include 'admin/partials/flash_messages.html' ignore missing %}

        <form method="POST" class="space-y-6">
            <div class="autocomplete-container relative w-full">
                <label for="student-search-input" class="block text-sm font-medium text-gray-700">Buscar Aluno</label>
                <input id="student-search-input" type="text" placeholder="Digite o nome ou e-mail do aluno..." required autocomplete="off" class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <div id="student-search-results" class="autocomplete-items hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto"></div>
                <input id="student-id" type="hidden" name="student_id">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-6">
                <div>
                    <label for="base_monthly_fee" class="block text-sm font-medium text-gray-700">Mensalidade (R$)</label>
                    <input type="number" step="0.01" name="base_monthly_fee" id="base_monthly_fee" value="{{ training_class.default_monthly_fee or '0.00' }}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="discount_amount" class="block text-sm font-medium text-gray-700">Desconto (R$)</label>
                    <input type="number" step="0.01" name="discount_amount" id="discount_amount" placeholder="0.00" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="due_day" class="block text-sm font-medium text-gray-700">Dia do Vencimento</label>
                    <input type="number" name="due_day" id="due_day" min="1" max="31" value="15" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                </div>
            </div>
            <div>
                <label for="discount_reason" class="block text-sm font-medium text-gray-700">Motivo do Desconto</label>
                <input type="text" name="discount_reason" id="discount_reason" placeholder="Ex: Plano Família, Bolsa" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
            </div>

            <div class="flex justify-end space-x-4 pt-4">
                <a href="{{ url_for('admin.edit_class', class_id=training_class.id) }}" class="px-6 py-2 border border-gray-300 text-base font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">Cancelar</a>
                <button type="submit" id="submit-button" disabled class="inline-flex items-center px-6 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Matricular Aluno</button>
            </div>
        </form>
    </div>
</div>

<script type="application/json" id="available-students-data">
    {{ available_students_json|tojson|safe }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const studentSearchInput = document.getElementById('student-search-input');
    const searchResultsContainer = document.getElementById('student-search-results');
    const studentIdInput = document.getElementById('student-id');
    const submitButton = document.getElementById('submit-button');
    const studentsDataElement = document.getElementById('available-students-data');
    const students = studentsDataElement ? JSON.parse(studentsDataElement.textContent) : [];

    studentSearchInput.addEventListener('input', function(e) {
        const query = this.value.toLowerCase();
        searchResultsContainer.innerHTML = '';
        studentIdInput.value = '';
        submitButton.disabled = true; // Desabilita o botão ao digitar

        if (query.length < 2) {
            searchResultsContainer.classList.add('hidden');
            return;
        }

        const filteredStudents = students.filter(student => 
            student.name.toLowerCase().includes(query) || student.email.toLowerCase().includes(query)
        );

        if (filteredStudents.length > 0) {
            searchResultsContainer.classList.remove('hidden');
            filteredStudents.forEach(student => {
                const resultDiv = document.createElement('div');
                resultDiv.classList.add('px-4', 'py-2', 'cursor-pointer', 'hover:bg-gray-100', 'autocomplete-result');
                resultDiv.innerHTML = `<strong>${student.name}</strong> <span class="text-xs text-gray-500">(${student.email})</span>`;
                
                resultDiv.dataset.studentId = student.id;
                resultDiv.dataset.studentName = student.name;
                
                searchResultsContainer.appendChild(resultDiv);
            });
        } else {
            searchResultsContainer.classList.add('hidden');
        }
    });

    // Evento de clique no container de resultados
    searchResultsContainer.addEventListener('click', function(e) {
        const resultDiv = e.target.closest('.autocomplete-result');
        if (resultDiv) {
            studentSearchInput.value = resultDiv.dataset.studentName;
            studentIdInput.value = resultDiv.dataset.studentId;
            searchResultsContainer.classList.add('hidden');
            submitButton.disabled = false; // Habilita o botão de matricular
        }
    });

    // Esconde os resultados se clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-container')) {
            searchResultsContainer.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}