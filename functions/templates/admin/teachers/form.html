{% extends "admin/base_admin.html" %}

{% block admin_title %}{{ 'Editar' if teacher else 'Adicionar' }} Professor{% endblock %}

{% block content %}
<div class="p-8 max-w-4xl mx-auto bg-white rounded-lg shadow-md">
    <h1 class="text-3xl font-bold mb-6">{{ 'Editar' if teacher else 'Adicionar' }} Professor</h1>
    
    {% include 'admin/partials/flash_messages.html' ignore missing %}

    <form method="POST" class="space-y-6">
        <div>
            <label for="name" class="block text-sm font-medium text-gray-700">Nome Completo do Professor:</label>
            <input type="text" id="name" name="name" value="{{ teacher.name if teacher else '' }}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        
        <div>
            <label for="user_id" class="block text-sm font-medium text-gray-700">Vincular Conta de Usuário (Login):</label>
            <select id="user_id" name="user_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <option value="">Selecione um usuário com nível 'teacher'</option>
                {% if current_linked_user %}
                    <option value="{{ current_linked_user.id }}" selected>{{ current_linked_user.name }} ({{ current_linked_user.email }})</option>
                {% endif %}
                {% for user in available_teacher_users %}
                    <option value="{{ user.id }}">{{ user.name }} ({{ user.email }})</option>
                {% endfor %}
            </select>
            <p class="mt-2 text-xs text-gray-500">
                Se o professor não estiver na lista, vá para a área de <a href="{{ url_for('admin.list_all_users') }}" class="text-indigo-600 hover:underline">Administração de Usuários</a>, 
                crie um novo usuário com o nível "teacher" e depois volte aqui para vinculá-lo.
            </p>
        </div>

        <div class="border-t pt-6 space-y-6">
            <h3 class="text-xl font-semibold">Detalhes de Contato e Modalidades</h3>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">E-mail de Contato (Público):</label>
                <input type="email" id="email" name="email" value="{{ teacher.contact_info.get('email', '') if teacher else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700">Telefone de Contato:</label>
                <input type="tel" id="phone" name="phone" value="{{ teacher.contact_info.get('phone', '') if teacher else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            
            <h4 class="text-lg font-semibold">Modalidades e Graduações</h4>
            <div id="disciplines-container" class="space-y-4">
                {% if teacher and teacher.disciplines %}
                    {% for discipline in teacher.disciplines %}
                        <div class="discipline-item flex flex-wrap items-end gap-4">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700">Modalidade:</label>
                                <input type="text" name="discipline_name_{{ loop.index0 }}" value="{{ discipline.discipline_name or discipline.get('discipline_name', '') }}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700">Graduação:</label>
                                <input type="text" name="graduation_{{ loop.index0 }}" value="{{ discipline.graduation or discipline.get('graduation', '') }}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <button type="button" class="remove-discipline px-4 py-2 bg-red-500 text-white font-medium rounded-lg shadow hover:bg-red-600">Remover</button>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            <button type="button" id="add-discipline" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300 mt-4">
                Adicionar Outra Modalidade
            </button>
        </div>
        
        <div>
            <label for="description" class="block text-sm font-medium text-gray-700">Descrição/Bio:</label>
            <textarea id="description" name="description" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">{{ teacher.description if teacher else '' }}</textarea>
        </div>
        
        <div class="flex justify-end mt-6">
            <button type="submit" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                {{ 'Salvar Alterações' if teacher else 'Adicionar Professor' }}
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addDisciplineBtn = document.getElementById('add-discipline');
        const disciplinesContainer = document.getElementById('disciplines-container');
        
        function updateDisciplineFieldNames() {
            const items = disciplinesContainer.querySelectorAll('.discipline-item');
            items.forEach((item, index) => {
                const disciplineNameInput = item.querySelector(`input[name^="discipline_name_"]`);
                const graduationInput = item.querySelector(`input[name^="graduation_"]`);
                if (disciplineNameInput) disciplineNameInput.name = `discipline_name_${index}`;
                if (graduationInput) graduationInput.name = `graduation_${index}`;
            });
        }

        function addDisciplineField() {
            const disciplineIndex = disciplinesContainer.children.length;
            const div = document.createElement('div');
            div.classList.add('discipline-item', 'flex', 'flex-wrap', 'items-end', 'gap-4');
            div.innerHTML = `
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700">Modalidade:</label>
                    <input type="text" name="discipline_name_${disciplineIndex}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700">Graduação:</label>
                    <input type="text" name="graduation_${disciplineIndex}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <button type="button" class="remove-discipline px-4 py-2 bg-red-500 text-white font-medium rounded-lg shadow hover:bg-red-600">Remover</button>
            `;
            disciplinesContainer.appendChild(div);
        }

        if (disciplinesContainer.children.length === 0) {
            addDisciplineField();
        }

        addDisciplineBtn.addEventListener('click', addDisciplineField);

        disciplinesContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-discipline')) {
                if (disciplinesContainer.children.length > 1) {
                    event.target.closest('.discipline-item').remove();
                    updateDisciplineFieldNames();
                } else {
                    alert('É necessário ter pelo menos uma modalidade.');
                }
            }
        });
    });
</script>
{% endblock %}